name: Code Guard

on:
  push:
    branches: [master]
    paths:
      - 'scripts/**/*.ts'
      - 'factory.config.ts'
      - '.github/workflows/**'

permissions:
  contents: read
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect direct push (not PR merge)
        id: detect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.sha }}"
          COMMIT_MSG=$(git log -1 --pretty=%s)
          AUTHOR=$(git log -1 --pretty=%an)

          echo "Commit: $SHA"
          echo "Message: $COMMIT_MSG"
          echo "Author: $AUTHOR"

          # Skip if this is a PR merge commit
          if echo "$COMMIT_MSG" | grep -qE "^Merge pull request #[0-9]+"; then
            echo "is_pr_merge=true" >> "$GITHUB_OUTPUT"
            echo "✓ PR merge commit - OK"
            exit 0
          fi

          # Skip if author is the bot (data file updates)
          if [ "$AUTHOR" = "devops-factory[bot]" ]; then
            echo "is_bot=true" >> "$GITHUB_OUTPUT"
            echo "✓ Bot commit - OK"
            exit 0
          fi

          # Check if commit is associated with any PR
          PR_COUNT=$(gh api "repos/${{ github.repository }}/commits/$SHA/pulls" --jq 'length' 2>/dev/null || echo "0")
          if [ "$PR_COUNT" -gt 0 ]; then
            echo "is_pr_merge=true" >> "$GITHUB_OUTPUT"
            echo "✓ Commit associated with PR - OK"
            exit 0
          fi

          # This is a direct push of code files
          echo "is_direct_push=true" >> "$GITHUB_OUTPUT"
          echo "⚠ Direct push of code files detected"

          # Get changed files
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "unknown")
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create warning issue for direct code push
        if: steps.detect.outputs.is_direct_push == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          AUTHOR=$(git log -1 --pretty=%an)
          MESSAGE=$(git log -1 --pretty=%s)
          CHANGED="${{ steps.detect.outputs.changed_files }}"

          # Rate limit: max 1 issue per day
          TODAY=$(date -u +%Y-%m-%d)
          EXISTING=$(gh issue list --repo "${{ github.repository }}" \
            --label "code-guard" --state open \
            --json title --jq "[.[] | select(.title | contains(\"$TODAY\"))] | length" 2>/dev/null || echo "0")

          if [ "$EXISTING" != "0" ]; then
            echo "Already alerted today, skipping"
            exit 0
          fi

          gh label create "code-guard" --repo "${{ github.repository }}" \
            --color "fbca04" --description "Direct code push to master detected" --force 2>/dev/null || true

          FILE_LIST=$(echo "$CHANGED" | head -20 | sed 's/^/- `/' | sed 's/$/`/')

          cat > /tmp/code-guard-body.md << ENDOFBODY
          ## Direct Code Push Detected

          Code files were pushed directly to master without a Pull Request.

          | Field | Value |
          |-------|-------|
          | **Commit** | [\`$SHORT_SHA\`](${{ github.server_url }}/${{ github.repository }}/commit/$SHA) |
          | **Author** | $AUTHOR |
          | **Message** | $MESSAGE |

          ### Changed files
          $FILE_LIST

          ### Why this matters
          Direct pushes to master bypass:
          - Code review
          - CI checks before merge
          - PR audit trail

          ### Recommended practice
          Use a feature branch + PR even for quick fixes:
          \`\`\`bash
          git checkout -b fix/my-change
          # make changes
          git push -u origin fix/my-change
          gh pr create --fill
          \`\`\`

          > This is a **warning**, not a blocker. Data file updates by workflows are excluded.

          ---
          *Auto-generated by Code Guard*
          ENDOFBODY

          gh issue create --repo "${{ github.repository }}" \
            --title "[Code Guard] Direct push to master - $TODAY" \
            --body-file /tmp/code-guard-body.md \
            --label "code-guard"
