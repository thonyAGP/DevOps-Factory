# DevOps-Factory: AI PR Description Generator
# Automatically generates PR descriptions from diff analysis
# Uses Claude Haiku for speed and cost efficiency

name: PR Description AI

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write

jobs:
  describe-pr:
    runs-on: ubuntu-latest
    if: github.event.pull_request.body == '' || github.event.pull_request.body == null
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff summary
        id: diff
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          # Get file stats
          STATS=$(git diff --stat "$BASE"..."$HEAD")
          FILES_CHANGED=$(git diff --name-only "$BASE"..."$HEAD" | wc -l)
          INSERTIONS=$(git diff --shortstat "$BASE"..."$HEAD" | grep -oP '\d+ insertion' | grep -oP '\d+' || echo "0")
          DELETIONS=$(git diff --shortstat "$BASE"..."$HEAD" | grep -oP '\d+ deletion' | grep -oP '\d+' || echo "0")

          # Get commit messages
          COMMITS=$(git log --oneline "$BASE"..."$HEAD" --no-merges)

          # Get the actual diff (limited to avoid token overflow)
          DIFF=$(git diff "$BASE"..."$HEAD" -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.css' '*.json' | head -500)

          {
            echo "FILES_CHANGED=$FILES_CHANGED"
            echo "INSERTIONS=$INSERTIONS"
            echo "DELETIONS=$DELETIONS"
          } >> "$GITHUB_OUTPUT"

          echo "$STATS" > /tmp/stats.txt
          echo "$COMMITS" > /tmp/commits.txt
          echo "$DIFF" > /tmp/diff.txt

      - name: Generate description with AI
        if: env.ANTHROPIC_API_KEY != ''
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-haiku-4-5-20251001
          direct_prompt: |
            Generate a concise PR description for this pull request.

            PR Title: ${{ github.event.pull_request.title }}
            Files changed: ${{ steps.diff.outputs.FILES_CHANGED }}
            Insertions: ${{ steps.diff.outputs.INSERTIONS }}
            Deletions: ${{ steps.diff.outputs.DELETIONS }}

            Commits:
            $(cat /tmp/commits.txt)

            File stats:
            $(cat /tmp/stats.txt)

            Diff (first 500 lines):
            $(cat /tmp/diff.txt)

            Format the description as:
            ## Summary
            <1-3 sentences describing what this PR does>

            ## Changes
            <bulleted list of key changes>

            ## Impact
            <what areas of the app are affected>

            Write the result to the PR body using the GitHub API.
          timeout_minutes: 3
          allowed_tools: 'Bash'

      - name: Fallback description (no AI)
        if: env.ANTHROPIC_API_KEY == ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commits = fs.readFileSync('/tmp/commits.txt', 'utf8').trim();
            const stats = fs.readFileSync('/tmp/stats.txt', 'utf8').trim();

            const body = [
              '## Summary',
              '',
              `${commits.split('\n').length} commit(s), ${('${{ steps.diff.outputs.FILES_CHANGED }}')} files changed`,
              '',
              '## Commits',
              commits.split('\n').map(c => `- ${c}`).join('\n'),
              '',
              '## File Stats',
              '```',
              stats,
              '```',
              '',
              `+${{ steps.diff.outputs.INSERTIONS }} / -${{ steps.diff.outputs.DELETIONS }}`,
            ].join('\n');

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body,
            });
