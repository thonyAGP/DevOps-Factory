# DevOps-Factory: Observability Stack (AUTO-86 + AUTO-87)
# GlitchTip (error tracking) + PostHog (product analytics)
# Run: docker compose -f docker-compose.observability.yml up -d

services:
  # ============================================
  # GlitchTip - Error Tracking (AUTO-86)
  # Sentry-compatible, self-hosted, lightweight
  # Dashboard: http://localhost:8000
  # ============================================
  glitchtip-web:
    image: glitchtip/glitchtip:latest
    container_name: glitchtip-web
    depends_on:
      glitchtip-db:
        condition: service_healthy
      glitchtip-redis:
        condition: service_started
    ports:
      - '8000:8000'
    environment:
      DATABASE_URL: postgres://${GLITCHTIP_DB_USER:-glitchtip}:${GLITCHTIP_DB_PASSWORD}@glitchtip-db:5432/glitchtip
      REDIS_URL: redis://glitchtip-redis:6379/0
      SECRET_KEY: ${GLITCHTIP_SECRET_KEY}
      PORT: 8000
      EMAIL_URL: consolemail://
      GLITCHTIP_DOMAIN: http://localhost:8000
      DEFAULT_FROM_EMAIL: glitchtip@localhost
      CELERY_WORKER_AUTOSCALE: '1,3'
      CELERY_WORKER_MAX_TASKS_PER_CHILD: 10000
    restart: unless-stopped
    volumes:
      - glitchtip-uploads:/code/uploads

  glitchtip-worker:
    image: glitchtip/glitchtip:latest
    container_name: glitchtip-worker
    depends_on:
      glitchtip-db:
        condition: service_healthy
      glitchtip-redis:
        condition: service_started
    command: ./bin/run-celery-with-beat.sh
    environment:
      DATABASE_URL: postgres://${GLITCHTIP_DB_USER:-glitchtip}:${GLITCHTIP_DB_PASSWORD}@glitchtip-db:5432/glitchtip
      REDIS_URL: redis://glitchtip-redis:6379/0
      SECRET_KEY: ${GLITCHTIP_SECRET_KEY}
    restart: unless-stopped

  glitchtip-db:
    image: postgres:16-alpine
    container_name: glitchtip-db
    environment:
      POSTGRES_DB: glitchtip
      POSTGRES_USER: ${GLITCHTIP_DB_USER:-glitchtip}
      POSTGRES_PASSWORD: ${GLITCHTIP_DB_PASSWORD}
    volumes:
      - glitchtip-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U glitchtip']
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  glitchtip-redis:
    image: redis:7-alpine
    container_name: glitchtip-redis
    restart: unless-stopped

  # ============================================
  # PostHog - Product Analytics (AUTO-87)
  # Self-hosted, event tracking, feature flags
  # Dashboard: http://localhost:8010
  # ============================================
  posthog:
    image: posthog/posthog:latest
    container_name: posthog
    depends_on:
      posthog-db:
        condition: service_healthy
      posthog-redis:
        condition: service_started
    ports:
      - '8010:8000'
    environment:
      DATABASE_URL: postgres://${POSTHOG_DB_USER:-posthog}:${POSTHOG_DB_PASSWORD}@posthog-db:5432/posthog
      REDIS_URL: redis://posthog-redis:6379/
      SECRET_KEY: ${POSTHOG_SECRET_KEY}
      SITE_URL: http://localhost:8010
      IS_BEHIND_PROXY: 'false'
      DISABLE_SECURE_SSL_REDIRECT: 'true'
    restart: unless-stopped

  posthog-db:
    image: postgres:16-alpine
    container_name: posthog-db
    environment:
      POSTGRES_DB: posthog
      POSTGRES_USER: ${POSTHOG_DB_USER:-posthog}
      POSTGRES_PASSWORD: ${POSTHOG_DB_PASSWORD}
    volumes:
      - posthog-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U posthog']
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  posthog-redis:
    image: redis:7-alpine
    container_name: posthog-redis
    restart: unless-stopped

volumes:
  glitchtip-db-data:
  glitchtip-uploads:
  posthog-db-data:
